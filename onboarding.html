<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onboarding - FinCtrl</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { 500: '#10b981' } } } }
    }
  </script>
  <meta name="robots" content="noindex" />
  <link rel="icon" href="data:," />
  <style>body{background:#f7f9fb}.dark body{background:#0f172a}</style>
  </head>
<script>(function(){try{var t=localStorage.getItem('fin.theme');if(!t){localStorage.setItem('fin.theme','light');t='light';}if(t==='dark')document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark');}catch(e){}})();</script>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-xl">
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="px-6 py-5 border-b border-slate-200 flex items-center gap-3">
        <img src="assets/images/logo.png" alt="Logo" class="w-9 h-9 rounded-lg" />
        <div>
          <h1 class="text-xl font-semibold">Let’s set up your account</h1>
          <p class="text-slate-500 text-sm">Provide your monthly budget and preferred currency to personalize the dashboard.</p>
        </div>
      </div>
      <form id="onboardingForm" class="p-6 space-y-4">
        <div>
          <label class="block text-slate-700 font-medium mb-2" for="monthlyBudget">Monthly budget</label>
          <input id="monthlyBudget" type="number" step="0.01" min="0" placeholder="e.g. 1500" required class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        </div>
        <div>
          <label class="block text-slate-700 font-medium mb-2" for="currency">Preferred currency</label>
          <select id="currency" required class="w-full rounded-lg border border-slate-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="" disabled selected>Select currency</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="INR">INR</option>
            <option value="JPY">JPY</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input id="emailAlerts" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" />
          <label for="emailAlerts" class="text-slate-700">Enable email alerts</label>
        </div>
        <div id="msg" class="hidden text-sm"></div>
        <div class="pt-2">
          <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-emerald-600 text-white px-4 py-2 font-medium hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">Save and continue</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function showMsg(text, ok=false){
      const el = document.getElementById('msg');
      el.className = ok ? 'text-emerald-600 text-sm' : 'text-rose-600 text-sm';
      el.textContent = text; el.classList.remove('hidden');
    }

    // Prefill currency based on browser locale (keeps UI-only; server still enforces)
    (function prefillCurrency(){
      try{
        const sel = document.getElementById('currency');
        if (!sel) return;
        // 0) User preference saved locally wins
        const saved = (typeof localStorage !== 'undefined') ? localStorage.getItem('preferredCurrency') : '';
        if (saved && Array.from(sel.options).some(o => o.value === saved)) {
          sel.value = saved;
          return;
        }
        // Don't override if a value is already set
        if (sel.value) return;
        const options = Array.from(sel.options).map(o => o.value);

        // 1) Prefer time zone mapping
        let cur = '';
        const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').toLowerCase();
        if (tz === 'asia/kolkata' || tz === 'asia/calcutta') cur = 'INR';

        // 2) Fallback to region from navigator.languages or navigator.language
        if (!cur) {
          const langs = Array.isArray(navigator.languages) && navigator.languages.length ? navigator.languages : [navigator.language || ''];
          let region = '';
          for (const lang of langs){
            const part = (lang || '').toLowerCase();
            const seg = part.split('-')[1];
            if (seg){ region = seg.toUpperCase(); break; }
          }
          const eu = new Set(['AT','BE','CY','EE','FI','FR','DE','GR','IE','IT','LV','LT','LU','MT','NL','PT','SK','SI','ES']);
          if (region === 'IN') cur = 'INR';
          else if (region === 'US') cur = 'USD';
          else if (region === 'GB') cur = 'GBP';
          else if (region === 'JP') cur = 'JPY';
          else if (eu.has(region)) cur = 'EUR';
        }

        if (cur && options.includes(cur)) sel.value = cur;
      } catch(_e) { /* no-op */ }
    })();

    // Save preference when user changes currency once
    (function bindCurrencyPersist(){
      const sel = document.getElementById('currency');
      if (!sel) return;
      sel.addEventListener('change', () => {
        try { if (sel.value) localStorage.setItem('preferredCurrency', sel.value); } catch(_e){}
      });
    })();

    document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const budget = parseFloat(document.getElementById('monthlyBudget').value);
      const currency = document.getElementById('currency').value;
      const emailAlerts = document.getElementById('emailAlerts').checked;
      if (isNaN(budget) || budget <= 0) { showMsg('Please enter a valid monthly budget'); return; }
      if (!currency) { showMsg('Please select your preferred currency'); return; }
      try {
        const res = await fetch('onboarding.php', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ monthlyBudget: budget, currency, emailAlerts })
        });
        const data = await res.json();
  if (data.success) { window.location.href = 'dashboard.html?skipOnboarding=1'; }
        else { showMsg(data.message || 'Failed to save settings'); }
      } catch(err){ showMsg('Network error. Try again.'); }
    });
  </script>
</body>
</html>
